# controlling the GPIO pins for calibrations

#---------------------------------------------------------------------------# 
# library for controling GPIO pins on RPi
#---------------------------------------------------------------------------#
import sys, os
import datetime, time
import RPi.GPIO as GPIO

import logging
#---------------------------------------------------------------------------#
#inputs from shell
#---------------------------------------------------------------------------#
#stable ==> here
#DataOutDirectory = "/data/PMoutputData/" #output directory
DataOutDirectory = "/media/particulatepi/data/PMoutputData/" #output directory

ZeroCallFromEnvidas = (DataOutDirectory + "ZeroCall" + ".txt")

if os.path.exists(ZeroCallFromEnvidas) == False:
    with open(ZeroCallFromEnvidas, "w") as myfile:
        myfile.write('[0]')
    
######################################### 
#(2) create log
#########################################
ZerofleLog = (DataOutDirectory + str(sys.argv[1]) + "_Zero_" + "Log.txt")

logger = logging.getLogger(__name__)
logger.setLevel(logging.INFO)

formatter = logging.Formatter('%(asctime)s:%(filename)s:%(funcName)s:%(levelname)s:%(levelno)s:%(message)s')

file_handler = logging.FileHandler(ZerofleLog)
file_handler.setFormatter(formatter)

logger.addHandler(file_handler)

#---------------------------------------------------------------------------#
#set up GPIO ports
try:
    pinhigh = GPIO.input(21)
except:
    GPIO.setmode(GPIO.BCM)
    GPIO.setup(21, GPIO.OUT)

#see if zero pin works
try:
    GPIO.output(21, GPIO.LOW)
    pinhigh = GPIO.input(21)
    logger.info('Zero pin works.  Force zero pin low.')
    
except:
    logger.info('Zero pin error.  Assume no zero.')
    
    #initialize pin setting
    pinhigh = 0

#---------------------------------------------------------------------------#
##check Cal call every minute
while True:
    
    time.sleep(5) 
    
    try:
        with open(ZeroCallFromEnvidas, 'r+') as myfile:
            doCal = myfile.readlines()[-1] 
        
    except: 
        logger.info('No Cal Call')
        
        
    #Check ENVIDAS call: 0 or 1 only 
    if 'doCal' in locals():
        if (doCal == '[1]') | (doCal == '[0]'):
            doCal = doCal[1] #extract value sent from ENVIDAS
        else:
            doCal = '0' #default - no calibrationdo        
    else:
         doCal = '0'
    
    #now set the GPIOpin
    pinhigh = GPIO.input(21)
    
    if (doCal == '1') & (pinhigh == False):
        GPIO.output(21, GPIO.HIGH)
        
    if (doCal == '0') & (pinhigh == True):
        GPIO.output(21, GPIO.LOW)
     

